@startuml
'https://plantuml.com/sequence-diagram

skinparam class {
  BackgroundColor<<appweb>>   #FFFFFF
  BorderColor<<appweb>>       #000000
  FontSize<<appweb>>          14

    BackgroundColor<<appUtils>>   #CCFFCC
    BorderColor<<appUtils>>       #000000
    FontSize<<appUtils>>          14

        BackgroundColor<<Object-appUtils>>   #CCFFCC
        BorderColor<<Object-appUtils>>       #000000
        FontSize<<Object-appUtils>>          14

        BackgroundColor<<appUI>>   #CCE5FF
        BorderColor<<appUI>>       #000000
        FontSize<<appUI>>          14

    BackgroundColor<<objectWeb>>   #FFFFFF
    BorderColor<<objectWeb>>       #000000
    FontSize<<objectWeb>>          14

  BackgroundColor<< inner class >> #FFF2CC
  BorderColor<< inner class >>     #C9A000
  FontSize<< inner class >>        12



  BackgroundColor<< anonymous, Handler >> #FFF2CC
    BorderColor<< anonymous, Handler >>     #C9A000
    FontSize<< anonymous, Handler >>        12

  BackgroundColor<<android>> #E0E0E0
  BorderColor<<android>>     #888888
  FontSize<<android>>        10
}

class  MainActivity <<appweb>>
{
            - const TAG : String = "MainActivity2"
            + const ACTION_WALLPAPER_UPDATE : String = "com.cvte.maxhub.uwst.WALLPAPER_UPDATE_ACTION"
            + const ACTION_TEMPLATE_CHANGED : String = "com.cvte.maxhub.uwst.TEMPLATE_CHANGED_ACTION"
            + const ACTION_HDMI_CHANGE : String = "hdmi_output_change_notify"
            - const ACTION_AP_CHANGE : String = "action.ap.change"
            - const SCREEN_SHARE_COUNT : Strig = "content_count"

            - webBroadcast : WebBroadcast? = null
            + glideFactory : DrawableCrossFadeFactory

            - webView: WebView? = null
            - lateinit bgImageview: ImageView

            - isRefresh : Boolean = false
            - isLocaleChange : Boolean = false
            - boxService: BoxService? = null

            - KEY_REBOOT : String = "KEY_REBOOT"
            - var rebootCount : Int = 0

           + onCreate(savedInstanceState: Bundle?) : void
           + onSaveInstanceState(outState: Bundle) : void
           + registerBoxService() : void
           + unRegisterService() : void
           - initWebView() : void
           - registerBroadcast() : void
           - refreshWebView() : void
           - showBackground() : void
           + onResume() : void
           + onPause() : void
           + onDestroy() : void
           + onKeyDown(keyCode: Int, event: KeyEvent?) : Boolean
           - initCrashReport() : void

}
class BoxService << inner class >> {
    + onServiceConnected(name: ComponentName?, service: IBinder?) : void
    + onServiceDisconnected(name: ComponentName?) : void
}
class ServiceConnection <<android>>{}
ServiceConnection <|-- BoxService : 继承
MainActivity *-- BoxService : 包含
class WebBroadcast << inner class >> {
    + onReceive(context: Context?, intent: Intent?) : void
}
class BroadcastReceiver<<android>>
BroadcastReceiver <|-- WebBroadcast : 继承
MainActivity *-- WebBroadcast : 包含
class WebViewSetting << inner class >> {
    + onReceiveError(view: WebView?, request: WebResourceRequest?, error: WebResourceError?) : void
    + onPageStarted(view: WebView?, url: String?, favicon: Bitmap?) : void
    + onPageFinished(view: WebView?, url: String?) : void
}
class WebViewClient<<android>>
MainActivity *-- WebViewSetting : 包含
WebViewClient <|-- WebViewSetting : 继承
class AppCompatActivity<<android>>
AppCompatActivity <|-- MainActivity : 继承

class MainApplication <<appweb>>{
    + handler : Handler
    + lateinit context : Context

    + onCreate() : void
    - getProcessName2() : String
}
class Application<<android>>
Application <|-- MainApplication : 继承


class CrashHandler <<appweb>>
{
    - defaultHandler: Thread.UncaughtExceptionHandler? = null
    + uncaughtException(thread: Thread, throwable: Throwable) : void
    + getCrashMsg(throwable: Throwable) : String
}
class Thread.UncaughtExceptionHandler <<android>>
Thread.UncaughtExceptionHandler   <|-- CrashHandler

class SystemUpdateManager <<objectWeb>>{
    - const TAG : String = "SystemUpdateService"
        - const WB03_UPDATE : String = "wb03_update.zip"
        - const WB05_UPDATE : String = "wb05_update.zip"
        - MSG_WAIT_UPDATE : Int = 0X02
        - MSG_QUERY_CHECK_USB : Int = 0X03
        - KEY_MD5 : String = "FILE_MD5"
        - TRY_AGAIN_COUNT : Int = 1

        ' 成员变量
        - context : Context = MainApplication.context
        - dialog : CusDialog?
        - waitCount : Int = 15
        - job : Job
        - scope : CoroutineScope
        - updateMd5 : String = ""
        - usbFile : File?
        - isCanUpdate : AtomicBoolean = AtomicBoolean(true)
        - usbCount : Int = 0
        - handler : Handler

        ' 公开方法
        + checkUpdateFle() : void
        + dismiss() : void

        ' 私有方法
        - deleteCache() : void
        - checkIfNeedUpdate(updateFile: File) : void
        - showDialog(file: File) : void
        - checkInstall() : void
        - startInstall(updateFile: File) : Boolean
        - getLocalUpdatePath() : String
        - showLoading() : void
}
class "<< anonymous >> Handler" << anonymous, Handler >> {
    ' 标注注解：用note关联
    + handleMessage(msg: Message) : void
}
' 关系连线
' 核心：SystemUpdateManager 包含匿名Handler（组合关系*--）
SystemUpdateManager *-- "<< anonymous >> Handler" : 包含（匿名object）
' 匿名Handler继承系统Handler（泛化关系--|>）
class Handler <<android>>
class Message <<android>>
"<< anonymous >> Handler" --|> Handler : 继承
' 匿名Handler依赖Message（处理消息需要Message）
"<< anonymous >> Handler" --> Message : 依赖

class WindowService <<appweb>>
{
- {static} TAG : String = "WindowService "
    - {static} PERSIST_KEEP_CODE_SHOW : String = "persist.code.keep.showing"
    - {static} SCREENSHARE_COUNT : String = "content_count"
    - {static} SCREEN_START : String = "com.maxhub.screenshare.server.SCREEN_SHARE_START"
    - {static} SCREEN_EXIT : String = "com.maxhub.screenshare.server.SCREEN_SHARE_EXIT"
    - {static} PERSIST_KEEP_SHOW_CODE : String = "persist.code.keep.showing"
    - {static} ACTION_CODE_KEEP_SHOW : String = "action.code.keep.show"

    ' 普通成员变量（private）
    - mFlatCodeView : FlatCodeView
    - mCurrentShareCount : int

    + WindowService() : void
    + onBind(intent: Intent) : IBinder
    + onCreate() : void
    + onStartCommand(intent: Intent?, flags: Int, startId: Int) : Int
    - showPinCode(boolean show) : void
    - onReceiveKeepCodeShowEvent(Intent intent) : void
    - onReceiveShareEndEnvent
}
class Service <<android>>
Service <|-- WindowService : 继承



class Constants <<objectWeb>> {
    ' 普通成员变量
    + context : Context = MainApplication.context

    ' const直接前置（和Kotlin源码一致：const val XXX）
    + const PORT : String = "8090"
    + const PROPERTY_WALLPAPER : String = "persist.use.custom.paper"
    + const STRING_TRUE : String = "true"
    + const STRING_FALSE : String = "false"
    + const PROPERTY_DESKTOP_URL : String = "persist.desktop.url"

    ' 普通val常量（无const标注）
    + IP : String = "0.0.0.0"
    + PATH_WALLPAPER : String = "/sdcard/wallpaper"
    + URL_DEFAULT_TEMPLATE : String = "http://0.0.0.0:8090/template/..."
    + PATH_WEB_PAPER : String = "/sdcard/.web_resource/..."
    + PIN_CODE_URL : String = "http://0.0.0.0:7434/api/query"
    + PERSIST_WB05_OTA_UPDATE : String = "persist.wb05.isotaUpdate"
    + OTA_INSTALL_PATH : String = "/cache/recovery/update.zip"
    + OTA_WB05_INSTALL_PATH : String = "/data/media/0/update.zip"

    ' 单例类方法
    + getApIp() : String
}

class BootBroadcast <<appweb>> {
  - TAG : String = "BootBroadcast"
  + onReceive(context: Context, intent: Intent?)
}
BroadcastReceiver <|-- BootBroadcast : 继承


class BackdoorImpl <<appweb>>
{
  - fianl activity :  Activity
  + BackdoorImpl(activity: Activity)
  - adbCount : Int = 0
  - settingCount : Int = 0
  - webSettingCount : Int = 0
  - launcherCount : Int = 0
  - ACTION_ZIP_LOG : String = "action.start.zip.log"
  - XBUG_SDCARD : String = "/sdcard/Logs/xbug.zip"
  - job : Job
  - scope : CoroutineScope

  - initLeftBottomSetting() : void
  - initLeftTopWebSetting() : void
  - isCanLog : Boolean = true
  - initRightTopInfo() : void
  - xbug() : MutableList<File>
  - dialog : CusDialog? = null
  - showDialog(msg: String,delay : Long = 0) : void
  - dismiss : void
  - hasXbug : Boolean
  + openAdb : void
  + isAdbEnable : Boolean = false
  - initRightBottomADB() : void
}

class ActivityUtil <<appUtils>>
{
    + {static} ACTIVITY_NAME_SCREEN_SHARE : String = "om.maxhub.screenshare.server.ui.display.DisplayActivity"
    + {static} ACTIVITY_NAME_LAUNCHER:String = "com.exceedshare.boxlauncher.MainActivity"
    + {static} getTopActivity(Context context) : String
}

class AppInfoUtil <<appUtils>>
{
    + {static} final getCommitId(context: Context) : String
    + {static} final getBranchName(context: Context) : String
    - {static} final getMetaDataFromApplication(context: Context,key : String) : String
    + {static} checkAppInstalled(context:Context,pkgName:String) : Boolean
    + {static} getMetaDataValue(context: Context, metaDataName: String) : String
    + {static} getDeviceSN():String

}

class FastBlur <<appUtils>>
{
  + {static} doBlur(Bitmap sentBitmap, int radius, boolean canReuseInBitmap) : Bitmap
 }

class IpHelepr <<Object-appUtils>> {
    - const IPADDRESS_PATTERN : String = "(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)"
    + findIpAddr(ipString : String?) : String?
    + getIpAddressString() : String

}

class JsonUtils <<appUtils>>
{
    + beanToJson(obj:Any) : String
    + jsonToBean<T>(jsonStr: String, clazz: Class<T>) : T
    ' 2. 内联具体化泛型函数：标注<<inline reified>>体现特性
    + jsonToBean<T>(jsonStr: String) : T <<inline reified>>
}

class PropertyHelper <<appUtils>>
{
    + PropertyHelper():void
    + {static} set(key: String, value: String) : void
    + {static} get(key: String,defaultValue : String) : String
}

class Rlog <<appUtils>> {
    ' 初始化方法：static + 完整参数 + 逻辑说明
    - {static} init(context: Context, path: String) : void

    ' 重载的日志方法：按级别分组，保留所有参数变体
    - {static} v(tag: String, message: String) : void
    - {static} v(message: String) : void

    - {static} i(message: String) : void
    - {static} i(tag: String, message: String) : void

    - {static} d(message: String) : void
    - {static} d(tag: String, message: String) : void
    - {static} d(tag: String, message: String, tr: Throwable) : void

    - {static} w(message: String) : void
    - {static} w(tag: String, message: String) : void
    - {static} w(tag: String, message: String, tr: Throwable) : void

    - {static} e(tx: Throwable) : void
    - {static} e(tag: String, message: String) : void
    - {static} e(message: String) : void
    - {static} e(tag: String, message: String, tr: Throwable) : void

    - {static} r(tag: String, message: String) : void
}

class ShellCommandUtils <<appUtils>>
{


}


@enduml
